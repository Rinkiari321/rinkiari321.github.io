<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Planer Meczowy - Optymalizacja Zdrowia</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 30px; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 5px; }
    th { background-color: #eee; }
    .player-table td { min-width: 100px; text-align: center; }
    button { margin-left: 5px; }
  </style>
</head>
<body>
  <h1>Symulacja Meczów i Zdrowia Zawodników</h1>

  <h2>Dodaj / Edytuj zawodnika</h2>
  <form id="playerForm">
    <input type="hidden" id="editIndex">
    Imię: <input type="text" id="playerName" required>
    Zdrowie: <input type="number" id="playerHealth" value="100" min="0" max="100" required>
    Kluczowy: <input type="checkbox" id="playerKey">
    Pozycja:
    <select id="playerPosition">
      <option value="BR">Bramkarz</option>
      <option value="OB">Obrońca</option>
      <option value="DP">Defensywny Pomocnik</option>
      <option value="PM">Pomocnik</option>
      <option value="OP">Ofensywny Pomocnik</option>
      <option value="NA">Napastnik</option>
    </select>
    <button type="submit">Zapisz</button>
  </form>

  <h3>Zawodnicy</h3>
  <table id="playerTable">
    <thead><tr><th>Imię</th><th>Zdrowie</th><th>Kluczowy</th><th>Pozycja</th><th>Akcje</th></tr></thead>
    <tbody></tbody>
  </table>

  <h2>Dodaj / Edytuj mecz</h2>
  <form id="matchForm">
    Dzień: <input type="number" id="matchDay" required>
    Typ meczu:
    <select id="matchType">
      <option value="sparing">Sparing</option>
      <option value="liga">Liga</option>
      <option value="superliga">SuperLiga</option>
      <option value="turniej">Turniej Mistrzów</option>
    </select>
    <button type="submit">Dodaj mecz</button>
  </form>

  <h3>Terminarz</h3>
  <ul id="scheduleList"></ul>

  <button onclick="simulate()">Symuluj Harmonogram</button>
  <pre id="output"></pre>

  <script>
    const matchTypes = {
      sparing:     { lossPer30: 0, changes: 9 },
      liga:        { lossPer30: 2, changes: 3 },
      superliga:   { lossPer30: 4, changes: 3 },
      turniej:     { lossPer30: 3, changes: 3 },
    };

    const formations = [
      { name: "3-4-3", structure: { BR:1, OB:3, DP:1, PM:2, OP:1, NA:3 } },
      { name: "3-3-4", structure: { BR:1, OB:3, DP:1, PM:1, OP:1, NA:4 } },
      { name: "4-3-3", structure: { BR:1, OB:4, DP:1, PM:1, OP:2, NA:3 } },
      { name: "4-4-2", structure: { BR:1, OB:4, DP:1, PM:2, OP:1, NA:2 } },
      { name: "5-3-2", structure: { BR:1, OB:5, DP:1, PM:1, OP:1, NA:2 } },
      { name: "3-5-2", structure: { BR:1, OB:3, DP:1, PM:2, OP:2, NA:2 } },
      { name: "4-5-1", structure: { BR:1, OB:4, DP:2, PM:2, OP:1, NA:1 } },
      { name: "5-4-1", structure: { BR:1, OB:5, DP:1, PM:2, OP:1, NA:1 } },
      { name: "3-1-4-2", structure: { BR:1, OB:3, DP:1, PM:2, OP:2, NA:2 } },
      { name: "3-1-5-1", structure: { BR:1, OB:3, DP:1, PM:3, OP:2, NA:1 } },
      { name: "3-4-2-1", structure: { BR:1, OB:3, DP:1, PM:3, OP:2, NA:1 } },
      { name: "3-5-1-1", structure: { BR:1, OB:3, DP:1, PM:4, OP:1, NA:1 } },
      { name: "4-1-4-1", structure: { BR:1, OB:4, DP:1, PM:3, OP:1, NA:1 } },
      { name: "4-2-3-1", structure: { BR:1, OB:4, DP:2, PM:1, OP:2, NA:1 } },
      { name: "4-3-1-2", structure: { BR:1, OB:4, DP:2, PM:1, OP:1, NA:2 } },
      { name: "4-3-2-1", structure: { BR:1, OB:4, DP:2, PM:1, OP:2, NA:1 } },
      { name: "5-2-1-2", structure: { BR:1, OB:5, DP:2, OP:1, NA:2 } },
      { name: "4-4-1-1", structure: { BR:1, OB:4, DP:2, PM:1, OP:1, NA:1 } },
      { name: "3-4-1-2", structure: { BR:1, OB:3, DP:2, PM:1, OP:1, NA:2 } },
      { name: "3-2-4-1", structure: { BR:1, OB:3, DP:2, PM:2, OP:2, NA:1 } },
    ];

    let players = [];
    let schedule = [];

    document.getElementById("playerForm").addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("playerName").value;
      const health = parseFloat(document.getElementById("playerHealth").value);
      const isKey = document.getElementById("playerKey").checked;
      const position = document.getElementById("playerPosition").value;
      const editIndex = document.getElementById("editIndex").value;

      if (editIndex) {
        players[editIndex] = { name, health, isKey, position };
      } else {
        players.push({ name, health, isKey, position });
      }
      e.target.reset();
      updatePlayerTable();
    });

    function updatePlayerTable() {
      const tbody = document.querySelector("#playerTable tbody");
      tbody.innerHTML = "";
      players.forEach((p, i) => {
        const row = `<tr>
          <td>${p.name}</td><td>${p.health}</td><td>${p.isKey ? "Tak" : "Nie"}</td><td>${p.position}</td>
          <td>
            <button onclick="editPlayer(${i})">Edytuj</button>
            <button onclick="deletePlayer(${i})">Usuń</button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    function editPlayer(i) {
      const p = players[i];
      document.getElementById("playerName").value = p.name;
      document.getElementById("playerHealth").value = p.health;
      document.getElementById("playerKey").checked = p.isKey;
      document.getElementById("playerPosition").value = p.position;
      document.getElementById("editIndex").value = i;
    }

    function deletePlayer(i) {
      players.splice(i, 1);
      updatePlayerTable();
    }

    document.getElementById("matchForm").addEventListener("submit", e => {
      e.preventDefault();
      const day = parseInt(document.getElementById("matchDay").value);
      const type = document.getElementById("matchType").value;
      const dayIndex = schedule.findIndex(d => d.day === day);
      if (dayIndex === -1) {
        schedule.push({ day, matches: [type] });
      } else {
        schedule[dayIndex].matches.push(type);
      }
      schedule.sort((a, b) => a.day - b.day);
      updateSchedule();
      e.target.reset();
    });

    function updateSchedule() {
      const list = document.getElementById("scheduleList");
      list.innerHTML = "";
      schedule.forEach((d, i) => {
        const li = document.createElement("li");
        li.textContent = `Dzień ${d.day}: ${d.matches.join(", ")}`;
        const btn = document.createElement("button");
        btn.textContent = "Usuń";
        btn.onclick = () => { schedule.splice(i, 1); updateSchedule(); };
        li.appendChild(btn);
        list.appendChild(li);
      });
    }

    function simulate() {
      const output = document.getElementById("output");
      let log = "";

      const clone = players.map(p => ({ ...p }));

      for (let dayInfo of schedule) {
        log += `\nDzień ${dayInfo.day}:\n`;
        const matches = dayInfo.matches;

        for (let matchType of matches) {
          const match = matchTypes[matchType];
          const bestFormation = chooseBestFormation(clone);
          const starters = chooseStarters(clone, match, bestFormation.structure);
          const subs = chooseSubs(clone, match, starters);

          applyHealthLoss(starters, subs, match);

          log += `  Mecz: ${matchType.toUpperCase()}\n`;
          log += `    Formacja: ${bestFormation.name}\n`;
          log += `    Startują: ${starters.map(p => p.name + ' (' + p.position + ')').join(", ")}\n`;
          log += `    Zmiany:  ${subs.map(p => p.name + ' (' + p.position + ')').join(", ")}\n`;
        }

        // regeneracja
        clone.forEach(p => p.health = Math.min(100, p.health + 6));

        log += `  Zdrowie po dniu:\n`;
        for (let p of clone) {
          log += `    ${p.name} (${p.position}) - ${p.health.toFixed(1)}%\n`;
        }
      }

      output.textContent = log;
    }
    function chooseBestFormation(players) {
      let best = null;
      let bestScore = -Infinity;

      for (let form of formations) {
        let totalScore = 0;
        let ok = true;

        for (let pos in form.structure) {
          const needed = form.structure[pos];
          const available = players
            .filter(p => p.position === pos && p.health > 30)
            .sort((a, b) => (b.isKey * 100 + b.health) - (a.isKey * 100 + a.health))
            .slice(0, needed);

          if (available.length < needed) {
            ok = false;
            break;
          }

          totalScore += available.reduce((sum, p) => sum + p.health + (p.isKey ? 20 : 0), 0);
        }

        if (ok && totalScore > bestScore) {
          bestScore = totalScore;
          best = form;
        }
      }

      return best || formations[0];
    }

    function chooseStarters(players, match, formationStructure) {
      const starters = [];
      const used = new Set();

      for (let pos of Object.keys(formationStructure)) {
        const count = formationStructure[pos];
        const available = players
          .filter(p => p.position === pos && p.health > 30 && !used.has(p.name))
          .sort((a, b) => (b.isKey * 100 + b.health) - (a.isKey * 100 + a.health))
          .slice(0, count);

        available.forEach(p => used.add(p.name));
        starters.push(...available);
      }

      return starters;
    }

    function chooseSubs(players, match, starters) {
      const starterNames = new Set(starters.map(p => p.name));
      return players
        .filter(p => !starterNames.has(p.name) && p.health > 30)
        .sort((a, b) => b.health - a.health)
        .slice(0, match.changes);
    }

    function applyHealthLoss(starters, subs, match) {
      const full = match.lossPer30 * 3;
      const sixty = match.lossPer30 * 2;
      const thirty = match.lossPer30 * 1;

      for (let i = 0; i < starters.length; i++) {
        if (i < subs.length) starters[i].health -= sixty;
        else starters[i].health -= full;
      }
      for (let sub of subs) {
        sub.health -= thirty;
      }
    }
  </script>
</body>
</html>
